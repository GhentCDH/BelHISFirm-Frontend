# Compose file to connect directly to scob db via vpn
# Using network mode host means you can't change the external ports
# this also means ontop and sampo-client will both want to use 8080, so you have to change
# the port sampo uses in sampo/client/webpack.client.dev.js
services:

  # Ontop Virtual Knowledge Graph
  vkg-scob:
    image: ontop/ontop:latest
    container_name: belhisfirm-scob-vkg
    restart: unless-stopped
    volumes:
      - ./vkg/input:/opt/ontop/input
      - ./vkg/jdbc:/opt/ontop/jdbc
    environment:
      ONTOP_ONTOLOGY_FILE: /opt/ontop/input/ontology.ttl
      ONTOP_MAPPING_FILE: /opt/ontop/input/mappings.ttl
      ONTOP_PROPERTIES_FILE: /opt/ontop/input/ontop.properties
      ONTOP_CORS_ALLOWED_ORIGINS: "*"
      ONTOP_LAZY_INIT: "true"
      ONTOP_DEV_MODE: "false"
      DB_URL: ${DB_URL_SCOB}
      DB_USER: ${DB_USER_SCOB}
      DB_PASSWORD: ${DB_PASSWORD_SCOB}
      DB_DRIVER: ${DB_DRIVER_SCOB}
    network_mode: host
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Varnish Cache Layer for Ontop
  varnish:
    image: varnish:8.0.0
    container_name: belhisfirm-varnish-dev
    volumes:
      - ./varnish/default.vcl:/etc/varnish/default.vcl:ro
    environment:
      VARNISH_SIZE: 256M
      VARNISH_HTTP_PORT: 8082
    command:
      - "-p"
      - "feature=+esi_ignore_https"
      - "-p"
      - "feature=+esi_disable_xml_check"
      - "-p"
      - "vcc_allow_inline_c=on"
    depends_on:
      vkg-scob:
        condition: service_healthy
    network_mode: host
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "varnishstat", "-1"]
      interval: 10s
      timeout: 3s
      retries: 3

  # Sampo UI - Client
  client:
    image: ghcr.io/ghentcdh/sampo-ui-client:latest
    container_name: sampo-ui-client-prod
    network_mode: host
    environment:
      API_URL: ${API_URL}

  # Sampo UI - Server
  server:
    image: ghcr.io/ghentcdh/sampo-ui-server:latest
    container_name: sampo-ui-server-prod
    network_mode: host
    environment:
      SPARQL_ENDPOINT: ${SPARQL_ENDPOINT}
    volumes:
      - ./sampo/configs:/app/configs

volumes:
  client_node_modules:
  server_node_modules:
